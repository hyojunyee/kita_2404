{% extends "base.html" %}
{% block title %}Leaflet 한국 지도 예제{% endblock %}

{% block content %}
<div id="mapContainer">
    <div id="map"></div>
</div>
<div id="seoulMapContainer" style="display: none;">
    <div id="seoulMap"></div>
    <button id="backButton" class="btn btn-primary">Back to Main Map</button>
</div>

<!-- 모달 창 -->
<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">서점 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
jQuery.noConflict(); // jQuery 충돌 방지

jQuery(document).ready(function($) {
    var mainMap = L.map('map').setView([36.5, 127.5], 7);
    var seoulMap = null; // 서울특별시 지도 객체 저장 변수
    var 서울서점데이터 = null; // 서울특별시 서점 데이터

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '지도 데이터 &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> 기여자들'
    }).addTo(mainMap);

    // 서점 데이터를 불러와서 지도에 마커 추가
    $.getJSON('static/book_store_all.json', function(data) {
        서울서점데이터 = data;

        // TL_SCCO_CTPRVN.json 파일을 불러와서 지역명과 중심 좌표를 매핑
        $.getJSON('static/TL_SCCO_CTPRVN.json', function(data) {
            L.geoJSON(data, {
                style: function(feature) {
                    var 지역명 = feature.properties.CTP_KOR_NM;
                    var 서점개수 = getCountByRegion(지역명);

                    // 색상을 서점 개수에 따라 지정
                    var fillColor = getColor(서점개수);

                    return {
                        weight: 1,
                        opacity: 1,
                        color: 'black',
                        fillOpacity: 0.7,
                        fillColor: fillColor
                    };
                },
                onEachFeature: function(feature, layer) {
                    var 지역명 = feature.properties.CTP_KOR_NM;

                    if (지역명 === '서울특별시') {
                        // 서울특별시인 경우 클릭 이벤트 설정
                        layer.on('click', function(e) {
                            $('#mapContainer').hide();
                            $('#seoulMapContainer').show();

                            // 이전 지도 제거
                            if (seoulMap) {
                                seoulMap.remove();
                                seoulMap = null;
                            }

                            // 서울특별시 지도 생성
                            seoulMap = L.map('seoulMap').setView([37.5665, 126.978], 11); // 서울시의 중심 좌표로 설정

                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 18,
                                attribution: '지도 데이터 &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> 기여자들'
                            }).addTo(seoulMap);

                            // 서울특별시 구 경계 GeoJSON 추가
                            var seoulUrl = 'static/Seoul_Gu.json';
                            $.getJSON(seoulUrl, function(seoulBoundaryData) {
                                L.geoJSON(seoulBoundaryData, {
                                    style: function(feature) {
                                        var 구명 = feature.properties.SIG_KOR_NM;
                                        var 서점개수 = getCountByGu(구명);

                                        // 색상을 서점 개수에 따라 지정
                                        var fillColor = getColor_seoul(서점개수);

                                        return {
                                            weight: 1,
                                            opacity: 1,
                                            color: 'black',
                                            fillOpacity: 0.7,
                                            fillColor: fillColor
                                        };
                                    },
                                    onEachFeature: function(feature, layer) {
                                        var 구명 = feature.properties.SIG_KOR_NM;

                                        // 클릭 이벤트 추가
                                        layer.on('click', function(e) {
                                            showModal(구명);
                                        });
                                    }
                                }).addTo(seoulMap);
                            });
                        });
                    } else {
                        // 그 외 지역은 팝업 창 설정
                        layer.bindPopup('<p>' + 지역명 + '</p><button class="btn btn-primary" onclick="showModal(\'' + 지역명 + '\')">서점 정보 보기</button>');
                    }
                }
            }).addTo(mainMap);
        });
    });

    // 서점 개수에 따른 색상 반환 함수
    function getColor(개수) {
        return 개수 > 400 ? '#7f2704' :
               개수 > 200 ? '#a63603' :
               개수 > 150 ? '#e6550d' :
               개수 > 100 ? '#fd8d3c' :
               개수 > 50 ? '#fdbe85' :
               개수 > 20 ? '#fee6ce' :
                            '#fff5eb';
    }

    // 서울특별시 서점 개수에 따른 색상 반환 함수
    function getColor_seoul(개수) {
        return 개수 > 100 ? '#7f2704' :
               개수 > 70 ? '#a63603' :
               개수 > 50 ? '#e6550d' :
               개수 > 30 ? '#fd8d3c' :
               개수 > 20 ? '#fdbe85' :
               개수 > 10 ? '#fee6ce' :
                            '#fff5eb';
    }

    // 각 지역의 서점 개수 반환 함수
    function getCountByRegion(지역명) {
        var count = 서점데이터.filter(function(서점) {
            return 서점['시/도'] === 지역명;
        }).length;
        return count;
    }

    // 각 구의 서점 개수 반환 함수
    function getCountByGu(구명) {
        var count = 서울서점데이터.filter(function(서점) {
            return 서점['시/군/구'] === 구명;
        }).length;
        return count;
    }

    // 모달 창 보여주기
    function showModal(구명) {
        var 서점개수 = getCountByGu(구명);
        var modalContent = '<p>' + 구명 + ' 서점 개수: ' + 서점개수 + '</p>';
        $('#modalContent').html(modalContent);
        $('#myModal').modal('show');
    }

    // 'Back to Main Map' 버튼 클릭 시 이벤트 처리
    $('#backButton').click(function() {
        $('#seoulMapContainer').hide();
        $('#mapContainer').show();
    });
});
</script>

{% endblock %}
