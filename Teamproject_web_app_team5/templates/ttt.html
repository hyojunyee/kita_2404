{% extends "base.html" %}
{% block title %}Leaflet 한국 지도 예제{% endblock %}

{% block content %}
<div id="map"></div>

<div class="legend">
    <div class="legend-title">인구 수 범례</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #b10026;"></span> 5,000,000 이상</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #e31a1c;"></span> 3,000,000 - 5,000,000</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #fc4e2a;"></span> 2,000,000 - 3,000,000</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #fd8d3c;"></span> 1,800,000 - 2,000,000</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #feb24c;"></span> 1,600,000 - 1,800,000</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #fed976;"></span> 1,400,000 - 1,600,000</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #ffeda0;"></span> 1,200,000 - 1,400,000</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #ffffcc;"></span> 1,000,000 - 1,200,000</div>
</div>

<!-- Modal -->
<div class="modal fade" id="seoulModal" tabindex="-1" aria-labelledby="seoulModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="seoulModalLabel">Seoul Districts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalMap"></div>
                <div id="chartContainer" class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-center">성별 인구 비율</h5>
                            <canvas id="genderChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-center">연령대별 인구 분포</h5>
                            <canvas id="ageDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <p><b>총 인구 수</b>: <span id="totalPopulation"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    var map = L.map('map').setView([36.5, 127.5], 7);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var markers = []; // 마커를 담을 배열
    var genderChart; // 성별 인구 비율 차트
    var ageDistributionChart; // 연령대별 인구 분포 차트

        // 서울의 각 구의 중심 좌표 및 이름
    var seoulDistricts = [
        { name: '강남구', center: [37.5172, 127.0473] },
        { name: '강동구', center: [37.5301, 127.1238] },
        { name: '강서구', center: [37.5658, 126.8225] },
        { name: '관악구', center: [37.4784, 126.9516] },
        { name: '광진구', center: [37.5420, 127.0838] },
        { name: '구로구', center: [37.4954, 126.8874] },
        { name: '금천구', center: [37.4601, 126.9000] },
        { name: '노원구', center: [37.6552, 127.0773] },
        { name: '도봉구', center: [37.6688, 127.0471] },
        { name: '동대문구', center: [37.5744, 127.0396] },
        { name: '동작구', center: [37.5125, 126.9395] },
        { name: '마포구', center: [37.5665, 126.9010] },
        { name: '서대문구', center: [37.5791, 126.9368] },
        { name: '서초구', center: [37.4837, 127.0324] },
        { name: '성동구', center: [37.5635, 127.0365] },
        { name: '성북구', center: [37.6065, 127.0276] },
        { name: '송파구', center: [37.5145, 127.1070] },
        { name: '양천구', center: [37.5270, 126.8560] },
        { name: '영등포구', center: [37.5208, 126.9134] },
        { name: '용산구', center: [37.5327, 126.9904] },
        { name: '은평구', center: [37.6176, 126.9227] },
        { name: '종로구', center: [37.5720, 126.9840] },
        { name: '중구', center: [37.5639, 126.9975] },
        { name: '중랑구', center: [37.6065, 127.0927] }
    ];

    // 서울 구의 마커 생성 및 이벤트 처리
    seoulDistricts.forEach(district => {
        var marker = L.marker(district.center, {opacity: 0}).addTo(map);
        marker.bindPopup('<b>' + district.name + '</b>');
        markers.push(marker);
    });

    // 지도 줌 레벨에 따라 마커 숨기기
    map.on('zoomend', function() {
        var currentZoom = map.getZoom();
        if (currentZoom < 11) {
            markers.forEach(marker => {
                marker.setOpacity(0); // 줌 레벨이 낮으면 마커 숨기기
            });
        } else {
            markers.forEach(marker => {
                marker.setOpacity(1); // 줌 레벨이 높으면 마커 보이기
            });
        }
    });

    // GeoJSON 데이터 가져오기
    $.ajax({
        dataType: "json",
        url: "/geojson",
        success: function(data) {
            L.geoJSON(data, {
                style: function(feature) {
                    var population = getPopulation(feature.properties.CTP_KOR_NM); // 특정 지역의 인구수 가져오기
                    var fillColor = getColor(population); // 색상 설정을 인구 수에 따라 변경
                    return {
                        fillColor: fillColor,
                        color: 'black',
                        weight: 1,
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: function(e) {
                            layer.setStyle({
                                fillOpacity: 0.1
                            });
                        },
                        mouseout: function(e) {
                            layer.setStyle({
                                fillOpacity: 0.7
                            });
                        },
                        click: function(e) {
                            var regionName = feature.properties.CTP_KOR_NM;
                            $('#seoulModal').modal('show');
                            populateModal(regionName);
                        }
                    });
                }
            }).addTo(map);
        }
    });

    // 서울 구 경계 GeoJSON 데이터 추가
    $.ajax({
        dataType: "json",
        url: "/static/Seoul_Gu.json",
        success: function(data) {
            L.geoJSON(data, {
                style: function(feature) {
                    return {
                        color: "#FF0000", // 경계선 색상 설정
                        weight: 2, // 경계선 두께 설정
                        fillOpacity: 0 // 채우기 투명도 설정
                    };
                },
                onEachFeature: function(feature, layer) {
                    // 마우스 오버 이벤트 처리
                    layer.on({
                        mouseover: function(e) {
                            var layer = e.target;
                            layer.setStyle({
                                fillColor: 'blue', // 마우스 오버 시 채우기 색상
                                fillOpacity: 0.5 // 마우스 오버 시 채우기 투명도
                            });
                        },
                        mouseout: function(e) {
                            var layer = e.target;
                            layer.setStyle({
                                fillColor: getColor(getPopulation(feature.properties.GU_NAME)), // 마우스가 떠나면 원래 인구에 따른 색상으로 복구
                                fillOpacity: 0.7 // 원래 채우기 투명도로 복구
                            });
                        }
                    });
                }
            }).addTo(map);
        }
    });



    // 특정 지역의 인구수 가져오기
    function getPopulation(regionName) {
        var population = 0;
        $.ajax({
            dataType: "json",
            url: "/population",
            async: false,
            success: function(data) {
                var record = data.find(item => item.행정구역 === regionName);
                if (record) {
                    population = record.인구수;
                }
            }
        });
        return population;
    }

    // 인구수에 따라 색상 결정하기
    function getColor(population) {
        return population > 5000000 ? '#b10026' :
            population > 3000000 ? '#e31a1c' :
            population > 2000000 ? '#fc4e2a' :
            population > 1800000 ? '#fd8d3c' :
            population > 1600000 ? '#feb24c' :
            population > 1400000 ? '#fed976' :
            population > 1200000 ? '#ffeda0' :
            population > 1000000 ? '#ffffcc' :
                                    '#ffffff'; // 최소 인구수에 대한 색상
    }

    function populateModal(regionName) {
    $.ajax({
        type: "GET",
        url: "/population",
        success: function(data) {
            // 선택된 지역의 데이터만 필터링
            var regionData = data.filter(item => item.행정구역 === regionName);

            if (regionData.length === 0) {
                console.log('No data available for this region');
                return;
            }

            // 전체 인구 데이터
            var totalPopulation = regionData.find(item => item.성별 === '전체' && item.연령대 === '전체').인구수;

            // 성별 인구 데이터
            var malePopulation = regionData.find(item => item.성별 === '남' && item.연령대 === '전체').인구수;
            var femalePopulation = regionData.find(item => item.성별 === '여' && item.연령대 === '전체').인구수;
            
            // 성별 인구 비율 데이터 준비
            var genderChartData = {
                labels: ['남성', '여성'],
                datasets: [{
                    label: '성별 인구 비율',
                    data: [malePopulation, femalePopulation],
                    backgroundColor: ['#1f77b4', '#ff7f0e']
                }]
            };

            // 연령대별 인구 분포 데이터 준비
            var ageDistributionData = regionData.filter(item => 
                item.성별 === '전체' && item.월 == 6 && item.연령대 !== '전체'
            ).map(item => ({
                ageGroup: item.연령대,
                population: parseInt(item.인구수)
            }));

            // 차트 초기화 및 업데이트
            if (genderChart) {
                genderChart.destroy();
            }
            if (ageDistributionChart) {
                ageDistributionChart.destroy();
            }

            // 성별 인구 비율 차트 업데이트
            var ctxGenderChart = document.getElementById('genderChart').getContext('2d');
            genderChart = new Chart(ctxGenderChart, {
                type: 'pie',
                data: genderChartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '성별 인구 비율'
                        }
                    }
                }
            });

            // 연령대별 인구 분포 차트 업데이트
            var ctxAgeDistribution = document.getElementById('ageDistributionChart').getContext('2d');
            ageDistributionChart = new Chart(ctxAgeDistribution, {
                type: 'bar',
                data: {
                    labels: ageDistributionData.map(item => item.ageGroup),
                    datasets: [{
                        label: '연령대별 인구 수',
                        data: ageDistributionData.map(item => item.population),
                        backgroundColor: '#36a2eb',
                        borderColor: '#36a2eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '연령대별 인구 분포'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 총 인구 수 업데이트
            $('#totalPopulation').text(totalPopulation);
            
            // 모달 타이틀 업데이트
            $('#seoulModalLabel').text(regionName + ' 인구 통계');
        }
    });
}
</script>

{% endblock %}
